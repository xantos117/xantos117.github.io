<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0"> -->
        <!-- <link rel="stylesheet" href="simple/simple.min.css"> -->
        <link rel="stylesheet" href="basic.css">
        <title>Watercolors</title>
        <script id="vertex-shader" type="x-shader/x-vertex">
            varying vec2 vUv;
            void main() {
                vUv = uv;
                gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
            }
          </script>
          
          <script id="fragment-shader" type="x-shader/x-fragment">
            #include <common>

            varying vec2 vUv;
            uniform vec3 iResolution;
            uniform float iTime;
            uniform vec4 inkColor;
            uniform sampler2D tSource;
            uniform vec2 mousePos;
            uniform float screenWidth;
            uniform float screenHeight;
            uniform bool mDown;

            
            void mainImage( out vec4 fragColor) {
                vec2 texel = vec2(1.0/screenWidth, 1.0/screenHeight);
                vec4 brush = vec4(1.);
                vec4 color1 = inkColor;
                vec4 color2 = vec4(0.0);
                float travelDist = (10. / 1000.) * iTime;

                vec2 diff = (vUv - mousePos)/texel;
                float dist = dot(diff, diff);
                vec4 curColor = texture2D(tSource,vUv);
                vec4 compColor;
                vec2 searchDir;

                compColor = vec4(0);

                for(float i = -1.; i<=1.001;i++){
                    for(float j=-1.;j<=1.001;j++){
                        if(!(i==0. && j==0.)){
                            curColor = texture2D(tSource,vec2(vUv.x + i*texel.x, vUv.y + j*texel.y));
                            compColor.r = max(compColor.r,curColor.r);
                            compColor.g = max(compColor.g,curColor.g);
                            compColor.b = max(compColor.b,curColor.b);
                        }
                    }
                }
                

                if(dist < 50. && mDown) {   
                    fragColor = color1 + curColor;
                }
                else {
                    compColor.r = min(1.,compColor.r);
                    compColor.g = min(1.,compColor.g);
                    compColor.b = min(1.,compColor.b);
                    fragColor = (compColor*0.99);
                }
                
            }
            
            void main() {
                mainImage(gl_FragColor);
            }
          </script>
          <script id="streamingPlus" type="x-shader/x-fragment">
            #include <common>

            varying vec2 vUv;
            uniform vec3 iResolution;
            uniform float iTime;
            uniform vec4 inkColor;
            // (e1,e2,e3,e4)
            uniform sampler2D stVecs;
            // (e5,e6,e7,e8)
            uniform sampler2D diagVecs;
            // (e0, u.x, u.y, rho)
            uniform sampler2D otherVecs;
            uniform sampler2D paperTexture;
            uniform vec2 mousePos;
            uniform float screenWidth;
            uniform float screenHeight;
            uniform bool mDown;
            uniform float omg;
            uniform float rho0;
            uniform float c;
            
            // lattice direction vectors
            vec2 e[9] = vec2[9](vec2(0,0),
                        vec2(1,0),
                        vec2(0,1),
                        vec2(-1,0),
                        vec2(0,-1),
                        vec2(1,1),
                        vec2(-1,1),
                        vec2(-1,-1),
                        vec2(1,-1));
            // lattice geometry constants
            float w[9] = float[9](4./9.,1./9.,1./9.,1./9.,1./9.,1./36.,1./36.,1./36.,1./36.);

            void streamIn(out vec4 fragColor) {
                vec2 texel = vec2(1.0/screenWidth, 1.0/screenHeight);
                vec4 stVec = texture2D(stVecs,vUv);

                vec2 diff = (vUv - mousePos)/texel;
                float dist = dot(diff, diff);

                //if(dist < 50. && mDown) {   
                //    stVec = vec4(1.0);
                //}

                stVec.b = texture2D(stVecs,vUv + e[1]*texel).b;
                stVec.r = texture2D(stVecs,vUv + e[3]*texel).r;
                stVec.g = texture2D(stVecs,vUv + e[4]*texel).g;
                stVec.a = texture2D(stVecs,vUv + e[2]*texel).a;

                fragColor = stVec;
            }

            void main() {
                streamIn(gl_FragColor);
            }
          </script>
          <script id="streamingX" type="x-shader/x-fragment">
            #include <common>

            varying vec2 vUv;
            uniform vec3 iResolution;
            uniform float iTime;
            uniform vec4 inkColor;
            // (e1,e2,e3,e4)
            uniform sampler2D stVecs;
            // (e5,e6,e7,e8)
            uniform sampler2D diagVecs;
            // (e0, u.x, u.y, rho)
            uniform sampler2D otherVecs;
            uniform sampler2D paperTexture;
            uniform vec2 mousePos;
            uniform float screenWidth;
            uniform float screenHeight;
            uniform bool mDown;
            uniform float omg;
            uniform float rho0;
            uniform float c;
            
            // lattice direction vectors
            vec2 e[9] = vec2[9](vec2(0,0),
                        vec2(1,0),
                        vec2(0,1),
                        vec2(-1,0),
                        vec2(0,-1),
                        vec2(1,1),
                        vec2(-1,1),
                        vec2(-1,-1),
                        vec2(1,-1));
            // lattice geometry constants
            float w[9] = float[9](4./9.,1./9.,1./9.,1./9.,1./9.,1./36.,1./36.,1./36.,1./36.);

            void streamIn(out vec4 fragColor) {
                vec2 texel = vec2(1.0/screenWidth, 1.0/screenHeight);
                vec4 diagVec = texture2D(diagVecs,vUv);

                vec2 diff = (vUv - mousePos)/texel;
                float dist = dot(diff, diff);

                //if(dist < 50. && mDown) {   
                //    diagVec = vec4(1.0);
                //}

                diagVec.r = texture2D(diagVecs,vUv + e[7]*texel).r;
                diagVec.g = texture2D(diagVecs,vUv + e[8]*texel).g;
                diagVec.b = texture2D(diagVecs,vUv + e[5]*texel).b;
                diagVec.a = texture2D(diagVecs,vUv + e[6]*texel).a;

                fragColor = diagVec;
            }

            void main() {
                streamIn(gl_FragColor);
            }
          </script>
          <script id="velDensUpdate" type="x-shader/x-fragment">
            #include <common>

            varying vec2 vUv;
            uniform vec3 iResolution;
            uniform float iTime;
            uniform vec4 inkColor;
            // (e1,e2,e3,e4)
            uniform sampler2D stVecs;
            // (e5,e6,e7,e8)
            uniform sampler2D diagVecs;
            // (e0, u.x, u.y, rho)
            uniform sampler2D otherVecs;
            uniform sampler2D paperTexture;
            uniform vec2 mousePos;
            uniform float screenWidth;
            uniform float screenHeight;
            uniform bool mDown;
            uniform float omg;
            uniform float rho0;
            uniform float c;
            
            // lattice direction vectors
            vec2 e[9] = vec2[9](vec2(0,0),
                        vec2(1,0),
                        vec2(0,1),
                        vec2(-1,0),
                        vec2(0,-1),
                        vec2(1,1),
                        vec2(-1,1),
                        vec2(-1,-1),
                        vec2(1,-1));
            // lattice geometry constants
            float w[9] = float[9](4./9.,1./9.,1./9.,1./9.,1./9.,1./36.,1./36.,1./36.,1./36.);
            

            float relax(float f,int i,vec2 u,float rho) {
                float deu = dot(e[i],u);
                float f_eq = w[i] *(rho + rho0 * ((3./(c*c))*deu + (9./(2.*(c*c*c*c))) * deu * deu  - (3./(2.*c*c)) * dot(u,u)));
                return (1. - omg) * f + omg * f_eq;
            }

            void stepTwo(out vec4 fragColor) {
                vec2 texel = vec2(1.0/screenWidth, 1.0/screenHeight);
                vec4 stVec = texture2D(stVecs,vUv);
                vec4 diagVec = texture2D(diagVecs,vUv);
                vec4 otherVec = texture2D(otherVecs,vUv);

                vec2 diff = (vUv - mousePos)/texel;
                float dist = dot(diff, diff);

                float rho = 0.;
                if(dist < 50. && mDown) {   
                    rho = 1.0;
                    otherVec.r = 1.0;
                }
                else {
                    rho = stVec.r + stVec.g + stVec.b + stVec.a + diagVec.r + diagVec.g + diagVec.b + diagVec.a + otherVec.r;
                    //rho *= 0.9;
                }

                vec2 u = e[1] * stVec.r + e[2] * stVec.g + e[3] * stVec.b + e[4] * stVec.a + e[5] * diagVec.r + e[6] * diagVec.g + e[7] * diagVec.b + e[8] * diagVec.a; 
                u *= (1./rho0);

                fragColor = vec4(relax(otherVec.r,0,u,rho), u.x, u.y, rho);
            }

            void main() {
                stepTwo(gl_FragColor);
            }
          </script>
          <script id="relaxPlus" type="x-shader/x-fragment">
            #include <common>

            varying vec2 vUv;
            uniform vec3 iResolution;
            uniform float iTime;
            uniform vec4 inkColor;
            // (e1,e2,e3,e4)
            uniform sampler2D stVecs;
            // (e5,e6,e7,e8)
            uniform sampler2D diagVecs;
            // (e0, u.x, u.y, rho)
            uniform sampler2D otherVecs;
            uniform sampler2D paperTexture;
            uniform vec2 mousePos;
            uniform float screenWidth;
            uniform float screenHeight;
            uniform bool mDown;
            uniform float omg;
            uniform float rho0;
            uniform float c;
            
            // lattice direction vectors
            vec2 e[9] = vec2[9](vec2(0,0),
                        vec2(1,0),
                        vec2(0,1),
                        vec2(-1,0),
                        vec2(0,-1),
                        vec2(1,1),
                        vec2(-1,1),
                        vec2(-1,-1),
                        vec2(1,-1));
            // lattice geometry constants
            float w[9] = float[9](4./9.,1./9.,1./9.,1./9.,1./9.,1./36.,1./36.,1./36.,1./36.);

            float relax(float f,int i) {
                vec2 u = texture2D(otherVecs,vUv).yz;
                float rho = texture2D(otherVecs,vUv).a;
                float deu = dot(e[i],u);
                float f_eq = w[i] *(rho + rho0 * ((3./(c*c))*deu + (9./(2.*(c*c*c*c))) * deu * deu  - (3./(2.*c*c)) * dot(u,u)));
                return (1. - omg) * f + omg * f_eq;
            }

            void stepTwo(out vec4 fragColor) {
                vec2 texel = vec2(1.0/screenWidth, 1.0/screenHeight);
                vec4 stVec = texture2D(stVecs,vUv);
                //vec4 diagVecs = texture2D(diagVecs,vUv);
                //vec4 otherVecs = texture2D(otherVecs,vUv);

                stVec.r = relax(stVec.r,1);
                stVec.g = relax(stVec.g,2);
                stVec.b = relax(stVec.b,3);
                stVec.a = relax(stVec.a,4);

                fragColor = stVec;
            }

            void main() {
                stepTwo(gl_FragColor);
            }
          </script>
          <script id="relaxX" type="x-shader/x-fragment">
            #include <common>

            varying vec2 vUv;
            uniform vec3 iResolution;
            uniform float iTime;
            uniform vec4 inkColor;
            // (e1,e2,e3,e4)
            uniform sampler2D stVecs;
            // (e5,e6,e7,e8)
            uniform sampler2D diagVecs;
            // (e0, u.x, u.y, rho)
            uniform sampler2D otherVecs;
            uniform sampler2D paperTexture;
            uniform vec2 mousePos;
            uniform float screenWidth;
            uniform float screenHeight;
            uniform bool mDown;
            uniform float omg;
            uniform float rho0;
            uniform float c;
            
            // lattice direction vectors
            vec2 e[9] = vec2[9](vec2(0,0),
                        vec2(1,0),
                        vec2(0,1),
                        vec2(-1,0),
                        vec2(0,-1),
                        vec2(1,1),
                        vec2(-1,1),
                        vec2(-1,-1),
                        vec2(1,-1));
            // lattice geometry constants
            float w[9] = float[9](4./9.,1./9.,1./9.,1./9.,1./9.,1./36.,1./36.,1./36.,1./36.);

            float relax(float f,int i) {
                vec2 u = texture2D(otherVecs,vUv).yz;
                float rho = texture2D(otherVecs,vUv).a;
                float deu = dot(e[i],u);
                float f_eq = w[i] *(rho + rho0 * ((3./(c*c))*deu + (9./(2.*(c*c*c*c))) * deu * deu  - (3./(2.*c*c)) * dot(u,u)));
                return (1. - omg) * f + omg * f_eq;
            }

            void stepTwo(out vec4 fragColor) {
                vec2 texel = vec2(1.0/screenWidth, 1.0/screenHeight);
                vec4 stVec = texture2D(stVecs,vUv);
                vec4 diagVec = texture2D(diagVecs,vUv);
                vec4 otherVec = texture2D(otherVecs,vUv);

                diagVec.r = relax(diagVec.r,5);
                diagVec.g = relax(diagVec.g,6);
                diagVec.b = relax(diagVec.b,7);
                diagVec.a = relax(diagVec.a,8);

                fragColor = diagVec;
            }

            void main() {
                stepTwo(gl_FragColor);
            }
          </script>
          <script id="fragment-screen" type="x-shader/x-fragment">
            #include <common>

            varying vec2 vUv;
            uniform vec3 iResolution;
            uniform float iTime;
            uniform vec4 inkColor;
            // (e1,e2,e3,e4)
            uniform sampler2D stVecs;
            // (e5,e6,e7,e8)
            uniform sampler2D diagVecs;
            // (e0, u.x, u.y, rho)
            uniform sampler2D otherVecs;
            uniform sampler2D paperTexture;
            uniform vec2 mousePos;
            uniform float screenWidth;
            uniform float screenHeight;
            uniform bool mDown;
            uniform float omg;
            uniform float rho0;
            uniform float c;
            
            // lattice direction vectors
            vec2 e[9] = vec2[9](vec2(0,0),
                        vec2(1,0),
                        vec2(0,1),
                        vec2(-1,0),
                        vec2(0,-1),
                        vec2(1,1),
                        vec2(-1,1),
                        vec2(-1,-1),
                        vec2(1,-1));
            // lattice geometry constants
            float w[9] = float[9](4./9.,1./9.,1./9.,1./9.,1./9.,1./36.,1./36.,1./36.,1./36.);
            
            void main() {
                vec4 otherVec = texture2D(otherVecs,vUv);
                vec4 paperVec = texture2D(paperTexture,vUv);
                float intens = min(otherVec.a,1.0);
                vec4 lColor = mix(paperVec+vec4(1.),vec4(vec3(0.),1.),intens);
                gl_FragColor = lColor;
                //gl_FragColor = vec4(vec3(intens),1.);
                //vec4 tVec = texture2D(diagVecs,vUv);
                //gl_FragColor = vec4(tVec.rgb,1);
            }
          </script>
    </head>

    <body>    
        <script type="module" src="bundle.js"></script>
    </body>
</html>